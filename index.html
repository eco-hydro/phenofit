<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extract Remote Sensing Vegetation Phenology  • phenofit</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Extract Remote Sensing Vegetation Phenology ">
<meta property="og:description" content="
    The merits of TIMESAT and phenopix are adopted. Besides, a simple and 
    growing season dividing method and a practical snow elimination method 
    based on Whittaker were proposed. 7 curve fitting methods and 4 phenology 
    extraction methods were provided. Parameters boundary are considered for 
    every curve fitting methods according to their ecological meaning. 
    And optimx is used to select best optimization method for different 
    curve fitting methods.
    Reference:
    Kong, D., (2020). R package: A state-of-the-art Vegetation Phenology extraction 
    package, phenofit version 0.2.6, &lt;https://doi.org/10.5281/zenodo.3605560&gt;;
    Kong, D., Zhang, Y., Wang, D., Chen, J., &amp; Gu, X. (2020). Photoperiod Explains 
    the Asynchronization Between Vegetation Carbon Phenology and Vegetation Greenness 
    Phenology. Journal of Geophysical Research: Biogeosciences, 125(8), e2020JG005636. 
    &lt;https://doi.org/10.1029/2020JG005636&gt;;
    Kong, D., Zhang, Y., Gu, X., &amp; Wang, D. (2019). A robust method for reconstructing 
    global MODIS EVI time series on the Google Earth Engine. 
    ISPRS Journal of Photogrammetry and Remote Sensing, 155, 13–24;
    Zhang, Q., Kong, D., Shi, P., Singh, V.P., Sun, P., 2018. Vegetation phenology 
    on the Qinghai-Tibetan Plateau and its response to climate change (1982–2013). 
    Agric. For. Meteorol. 248, 408–417. &lt;doi:10.1016/j.agrformet.2017.10.026&gt;.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">phenofit</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/phenofit-procedures.html">Detailed procedures of phenofit</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kongdd/phenofit/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div id="phenofit" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#phenofit" class="anchor"></a>phenofit</h1></div>

<p>A state-of-the-art <strong>remote sensing vegetation phenology</strong> extraction package: <code>phenofit</code></p>
<ul>
<li>
<code>phenofit</code> combine merits of TIMESAT and phenopix</li>
<li>A simple and stable growing season dividing methods was proposed</li>
<li>Provide a practical snow elimination method, based on Whittaker</li>
<li>7 curve fitting methods and 4 phenology extraction methods</li>
<li>We add parameters boundary for every curve fitting methods according to their ecological meaning.</li>
<li>
<code>optimx</code> is used to select best optimization method for different curve fitting methods.</li>
</ul>
<p><strong><em>Task lists</em></strong></p>
<ul>
<li>
<input type="checkbox" disabled>
Test the performance of <code>phenofit</code> in multiple growing season regions (e.g. the North China Plain);</li>
<li>
<input type="checkbox" disabled>
Uncertainty analysis of curve fitting and phenological metrics;</li>
<li>
<input type="checkbox" disabled checked>
shiny app has been moved to <a href="https://github.com/kongdd/phenofit.shiny">phenofit.shiny</a>;</li>
<li>
<input type="checkbox" disabled checked>
Complete script automatic generating module in shinyapp;</li>
<li>
<input type="checkbox" disabled checked><code>Rcpp</code> improve double logistics optimization efficiency by 60%;</li>
<li>
<input type="checkbox" disabled checked>
Support spatial analysis;</li>
<li>
<input type="checkbox" disabled checked>
Support annual season in curve fitting;</li>
<li>
<input type="checkbox" disabled checked>
flexible fine fitting input ( original time-series or smoothed time-series by rough fitting).</li>
<li>
<input type="checkbox" disabled checked>
Asymmetric of Threshold method</li>
</ul>
<p><img src="man/Figure/Figure1_phenofit_flowchart.svg" alt="title"></p>
<p><em><u>Figure 1. The flowchart of phenology extraction in <code>phenofit</code>.</u></em></p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>You can install phenofit from github with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"kongdd/phenofit"</span><span class="op">)</span></code></pre></div>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>Here, we illustrate how to use <code>phenofit</code> to extract vegetation phenology from MOD13A1 in the sampled points. Regional analysis also can be conducted in the similar way.</p>
<!-- ## 1.1 Download MOD13A1 data

Upload point shapefile into GEE, clip MOD13A1 and download vegetation index
data. [Here](https://code.earthengine.google.com/ee3ec39cf3061374dab435c358d008a3) is the corresponding GEE script. 
 -->
<div id="11-initial-weights-for-input-data" class="section level2">
<h2 class="hasAnchor">
<a href="#11-initial-weights-for-input-data" class="anchor"></a>1.1 Initial weights for input data</h2>
<p>Load packages.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://had.co.nz/plyr">plyr</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kongdd/phenofit">phenofit</a></span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Set global parameters for <code>phenofit</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># lambda   &lt;- 5    # non-parameter Whittaker, only suit for 16-day. Other time-scale</span>
<span class="co"># should assign a lambda.</span>
<span class="va">ymax_min</span>   <span class="op">&lt;-</span> <span class="fl">0.1</span>  <span class="co"># the maximum ymax shoud be greater than `ymax_min` </span>
<span class="va">rymin_less</span> <span class="op">&lt;-</span> <span class="fl">0.8</span>  <span class="co"># trough &lt; ymin + A*rymin_less</span>
<span class="va">nptperyear</span> <span class="op">&lt;-</span> <span class="fl">23</span>   <span class="co"># How many points for a single year</span>
<span class="va">wFUN</span>       <span class="op">&lt;-</span> <span class="va">wBisquare</span> <span class="co">#wTSM #wBisquare # Weights updating function, could be one of `wTSM`, 'wBisquare', `wChen` and `wSELF`. </span></code></pre></div>
<ul>
<li>Add date according to composite day of the year (DayOfYear), other than image date.</li>
<li>Add weights according to <code>SummaryQA</code>.</li>
</ul>
<p>For MOD13A1, Weights can by initialed by <code>SummaryQA</code> band (also suit for MOD13A2 and MOD13Q1). There is already a <code>QC</code> function for <code>SummaryQA</code>, i.e. <code>qc_summary</code>.</p>
<table class="table">
<thead><tr class="header">
<th>SummaryQA</th>
<th>Pixel reliability summary QA</th>
<th>weight</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>-1 Fill/No data</td>
<td>Not processed</td>
<td><code>wmin</code></td>
</tr>
<tr class="even">
<td>0 Good data</td>
<td>Use with confidence</td>
<td>1</td>
</tr>
<tr class="odd">
<td>1 Marginal data</td>
<td>Useful but look at detailed QA for more information</td>
<td>0.5</td>
</tr>
<tr class="even">
<td>2 Snow/ice</td>
<td>Pixel covered with snow/ice</td>
<td><code>wmin</code></td>
</tr>
<tr class="odd">
<td>3 Cloudy</td>
<td>Pixel is cloudy</td>
<td><code>wmin</code></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'MOD13A1'</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">MOD13A1</span><span class="op">$</span><span class="va">dt</span> 
<span class="va">st</span> <span class="op">&lt;-</span> <span class="va">MOD13A1</span><span class="op">$</span><span class="va">st</span>

<span class="va">df</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, year <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, doy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/IDateTime.html">yday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">DayOfYear</span><span class="op">)</span>, <span class="va">DayOfYear</span> <span class="op">:=</span> <span class="va">doy</span><span class="op">]</span> <span class="co"># If DayOfYear is missing</span>
    
<span class="co"># In case of last scene of a year, doy of last scene could in the next year</span>
<span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">DayOfYear</span> <span class="op">-</span> <span class="va">doy</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">300</span>, <span class="va">t</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%d-%03d"</span>, <span class="va">year</span><span class="op">+</span><span class="fl">1</span>, <span class="va">DayOfYear</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">]</span> <span class="co"># last scene</span>
<span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">DayOfYear</span> <span class="op">-</span> <span class="va">doy</span><span class="op">)</span> <span class="op">&lt;</span>  <span class="fl">300</span>, <span class="va">t</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%d-%03d"</span>, <span class="va">year</span>  , <span class="va">DayOfYear</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">]</span>

<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html">.</a></span><span class="op">(</span><span class="va">site</span>, <span class="va">t</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># MCD12Q1.006 land cover 1-17, IGBP scheme</span>
<span class="va">IGBPnames_006</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ENF"</span>, <span class="st">"EBF"</span>, <span class="st">"DNF"</span>, <span class="st">"DBF"</span>, <span class="st">"MF"</span> , <span class="st">"CSH"</span>, 
              <span class="st">"OSH"</span>, <span class="st">"WSA"</span>, <span class="st">"SAV"</span>, <span class="st">"GRA"</span>, <span class="st">"WET"</span>, <span class="st">"CRO"</span>, 
              <span class="st">"URB"</span>, <span class="st">"CNV"</span>, <span class="st">"SNOW"</span>, <span class="st">"BSV"</span>, <span class="st">"water"</span>, <span class="st">"UNC"</span><span class="op">)</span>
<span class="co"># Initial weights</span>
<span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"QC_flag"</span>, <span class="st">"w"</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="reference/getBits.html">qc_summary</a></span><span class="op">(</span><span class="va">SummaryQA</span><span class="op">)</span><span class="op">]</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html">.</a></span><span class="op">(</span><span class="va">site</span>, y <span class="op">=</span> <span class="va">EVI</span><span class="op">/</span><span class="fl">1e4</span>, <span class="va">t</span>, <span class="va">date</span>, <span class="va">w</span>, <span class="va">QC_flag</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<ul>
<li>
<code>add_HeadTail</code> is used to deal with such situation, e.g. MOD13A2 begins from 2000-02-08. We need to construct a series with complete year, which begins from 01-01 for NH, and 07-01 for SH. For example, the input data period is 20000218 ~ 20171219. After adding one year in head and tail, it becomes 19990101 ~ 20181219.</li>
</ul>
</div>
<div id="21-load-site-data" class="section level2">
<h2 class="hasAnchor">
<a href="#21-load-site-data" class="anchor"></a>2.1 load site data</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sites</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">site</span><span class="op">)</span>
<span class="va">sitename</span>     <span class="op">&lt;-</span> <span class="va">sites</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="va">d</span>            <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">site</span> <span class="op">==</span> <span class="va">sitename</span><span class="op">]</span> <span class="co"># get the first site data</span>
<span class="va">sp</span>           <span class="op">&lt;-</span> <span class="va">st</span><span class="op">[</span><span class="va">site</span> <span class="op">==</span> <span class="va">sitename</span><span class="op">]</span>

<span class="va">south</span>      <span class="op">&lt;-</span> <span class="va">sp</span><span class="op">$</span><span class="va">lat</span> <span class="op">&lt;</span> <span class="fl">0</span>
<span class="va">print</span>      <span class="op">&lt;-</span> <span class="cn">FALSE</span> <span class="co"># whether print progress</span>
<span class="va">IsPlot</span>     <span class="op">&lt;-</span> <span class="cn">TRUE</span>  <span class="co"># for brks</span>

<span class="va">prefix_fig</span> <span class="op">&lt;-</span> <span class="st">"phenofit"</span>
<span class="va">titlestr</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">sp</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'[%03d,%s] %s, lat = %5.2f, lon = %6.2f'</span>,
                                     <span class="va">ID</span>, <span class="va">site</span>, <span class="va">IGBPname</span>, <span class="va">lat</span>, <span class="va">lon</span><span class="op">)</span><span class="op">)</span>
<span class="va">file_pdf</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'Figure/%s_[%03d]_%s.pdf'</span>, <span class="va">prefix_fig</span>, <span class="va">sp</span><span class="op">$</span><span class="va">ID</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sp</span><span class="op">$</span><span class="va">site</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>If need night temperature (Tn) to constrain ungrowing season backgroud value, NA values in Tn should be filled.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span><span class="op">$</span><span class="va">Tn</span> <span class="op">%&lt;&gt;%</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/na.approx.html">na.approx</a></span><span class="op">(</span>maxgap <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Tn</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">5</span>, b <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
</div>
<div id="22-check-input-data" class="section level2">
<h2 class="hasAnchor">
<a href="#22-check-input-data" class="anchor"></a>2.2 Check input data</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dnew</span>  <span class="op">&lt;-</span> <span class="fu"><a href="reference/add_HeadTail.html">add_HeadTail</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">south</span>, nptperyear <span class="op">=</span> <span class="fl">23</span><span class="op">)</span> <span class="co"># add additional one year in head and tail</span>
<span class="va">INPUT</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/check_input.html">check_input</a></span><span class="op">(</span><span class="va">dnew</span><span class="op">$</span><span class="va">t</span>, <span class="va">dnew</span><span class="op">$</span><span class="va">y</span>, <span class="va">dnew</span><span class="op">$</span><span class="va">w</span>, <span class="va">dnew</span><span class="op">$</span><span class="va">QC_flag</span>,
                     <span class="va">nptperyear</span>, <span class="va">south</span>, 
                     maxgap <span class="op">=</span> <span class="va">nptperyear</span><span class="op">/</span><span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">0.02</span>, wmin <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></code></pre></div>
</div>
<div id="23-divide-growing-seasons" class="section level2">
<h2 class="hasAnchor">
<a href="#23-divide-growing-seasons" class="anchor"></a>2.3 Divide growing seasons</h2>
<p>Simply treating calendar year as a complete growing season will induce a considerable error for phenology extraction. A simple growing season dividing method was proposed in <code>phenofit</code>.</p>
<p>The growing season dividing method rely on heavily in Whittaker smoother.</p>
<p>Procedures of initial weight, growing season dividing, curve fitting, and phenology extraction are conducted separately.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, mgp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0.6</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/init_lambda.html">init_lambda</a></span><span class="op">(</span><span class="va">INPUT</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="co"># The detailed information of those parameters can be seen in `season`.</span>
<span class="co"># brks   &lt;- season(INPUT, nptperyear,</span>
<span class="co">#                FUN = smooth_wWHIT, wFUN = wFUN, iters = 2,</span>
<span class="co">#                lambda = lambda,</span>
<span class="co">#                IsPlot = IsPlot, plotdat = d,</span>
<span class="co">#                south = d$lat[1] &lt; 0,</span>
<span class="co">#                rymin_less = 0.6, ymax_min = ymax_min,</span>
<span class="co">#                max_MaxPeaksperyear =2.5, max_MinPeaksperyear = 3.5) #, ...</span>
<span class="co"># get growing season breaks in a 3-year moving window</span>
<span class="va">brks2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/season.html">season_mov</a></span><span class="op">(</span><span class="va">INPUT</span>, 
                   FUN <span class="op">=</span> <span class="va">smooth_wWHIT</span>, wFUN <span class="op">=</span> <span class="va">wFUN</span>,
                   maxExtendMonth <span class="op">=</span> <span class="fl">6</span>, r_min <span class="op">=</span> <span class="fl">0.1</span>,
                   IsPlot <span class="op">=</span> <span class="va">IsPlot</span>, IsPlot.OnlyBad <span class="op">=</span> <span class="cn">FALSE</span>, print <span class="op">=</span> <span class="va">print</span><span class="op">)</span></code></pre></div>
<p><img src="man/Figure/divide%20growing%20season-1.svg" style="display: block; margin: auto;"></p>
</div>
<div id="24-curve-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#24-curve-fitting" class="anchor"></a>2.4 Curve fitting</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span>  <span class="op">&lt;-</span> <span class="fu"><a href="reference/curvefits.html">curvefits</a></span><span class="op">(</span><span class="va">INPUT</span>, <span class="va">brks2</span>,
                  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AG"</span>, <span class="st">"Zhang"</span>, <span class="st">"Beck"</span>, <span class="st">"Elmore"</span><span class="op">)</span>, <span class="co">#,"klos",, 'Gu'</span>
                  wFUN <span class="op">=</span> <span class="va">wFUN</span>,
                  nextend <span class="op">=</span> <span class="fl">2</span>, maxExtendMonth <span class="op">=</span> <span class="fl">3</span>, minExtendMonth <span class="op">=</span> <span class="fl">1</span>, minPercValid <span class="op">=</span> <span class="fl">0.2</span>,
                  print <span class="op">=</span> <span class="va">print</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## check the curve fitting parameters</span>
<span class="va">l_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_param.html">get_param</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">l_param</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co"># List of 4</span>
<span class="co">#  $ AG    : tibble [18 x 8] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#  $ Beck  : tibble [18 x 7] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#  $ Elmore: tibble [18 x 8] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#  $ Zhang : tibble [18 x 8] (S3: tbl_df/tbl/data.frame)</span>
<span class="co"># NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">l_param</span><span class="op">$</span><span class="va">AG</span><span class="op">)</span>
<span class="co"># # A tibble: 18 x 8</span>
<span class="co">#    flag      t0    mn    mx    rsp    a3     rau    a5</span>
<span class="co">#    &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#  1 2000_1  199. 0.167 0.407 0.0351  3.19 0.0146   6   </span>
<span class="co">#  2 2001_1  579. 0.169 0.397 0.0157  6    0.0227   4.57</span>
<span class="co">#  3 2002_1  934. 0.167 0.528 0.0329  2    0.0161   2   </span>
<span class="co">#  4 2003_1 1275. 0.167 0.432 0.0268  2    0.0123   3.73</span>
<span class="co">#  5 2004_1 1689. 0.169 0.445 0.0166  5.08 0.0372   2   </span>
<span class="co">#  6 2005_1 2052. 0.172 0.470 0.0141  6    0.0301   2   </span>
<span class="co">#  7 2006_1 2370. 0.166 0.420 0.0280  2.02 0.0112   3.12</span>
<span class="co">#  8 2007_1 2751. 0.165 0.479 0.0212  2    0.0142   2.98</span>
<span class="co">#  9 2008_1 3123. 0.169 0.481 0.0215  2.70 0.0164   6   </span>
<span class="co"># 10 2009_1 3522. 0.168 0.479 0.0142  6    0.0278   2   </span>
<span class="co"># 11 2010_1 3840. 0.167 0.489 0.0229  2    0.0131   2   </span>
<span class="co"># 12 2011_1 4208. 0.175 0.468 0.0288  2    0.0133   5.00</span>
<span class="co"># 13 2012_1 4558. 0.166 0.505 0.0478  2    0.0109   4.16</span>
<span class="co"># 14 2013_1 4968. 0.166 0.484 0.0137  6    0.0204   2.26</span>
<span class="co"># 15 2014_1 5328. 0.168 0.501 0.0166  3.90 0.0164   2.35</span>
<span class="co"># 16 2015_1 5701. 0.189 0.484 0.0146  6    0.0287   2.03</span>
<span class="co"># 17 2016_1 6027. 0.172 0.472 0.0299  2    0.0130   5.57</span>
<span class="co"># 18 2017_1 6381. 0.168 0.441 0.0403  2.95 0.00979  5.98</span>

<span class="va">d_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_fitting.html">get_fitting</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co">## Get GOF information</span>
<span class="va">d_gof</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_GOF.html">get_GOF</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co"># fit$stat &lt;- stat</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">d_gof</span><span class="op">)</span><span class="op">)</span>
<span class="co">#      flag   meth       RMSE       NSE         R       pvalue  n</span>
<span class="co"># 1: 2000_1     AG 0.09691142 0.4963370 0.9104446 4.481677e-11 27</span>
<span class="co"># 2: 2000_1   Beck 0.09688513 0.4966102 0.9127208 3.289646e-11 27</span>
<span class="co"># 3: 2000_1 Elmore 0.09690657 0.4963874 0.9109116 4.209014e-11 27</span>
<span class="co"># 4: 2000_1  Zhang 0.09688479 0.4966137 0.9127908 3.258098e-11 27</span>
<span class="co"># 5: 2001_1     AG 0.08197474 0.6537794 0.9011935 5.927392e-08 20</span>
<span class="co"># 6: 2001_1   Beck 0.08139990 0.6586180 0.9047362 4.324325e-08 20</span>

<span class="co"># print(fit$fits$AG$`2002_1`$ws)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">`2002_1`</span><span class="op">$</span><span class="va">fFIT</span><span class="op">$</span><span class="va">AG</span><span class="op">$</span><span class="va">ws</span><span class="op">)</span>
<span class="co"># $iter1</span>
<span class="co">#  [1] 0.8 0.2 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.5 1.0 1.0 1.0 1.0 0.5 1.0</span>
<span class="co"># [20] 1.0 1.0 1.0 0.2 0.2 0.2 0.2 0.2 0.8 0.8 0.8 0.8 0.8</span>
<span class="co"># </span>
<span class="co"># $iter2</span>
<span class="co">#  [1] 0.8000000 0.2000000 0.8000000 0.8000000 0.8000000 0.8000000 0.8000000</span>
<span class="co">#  [8] 0.8000000 0.8000000 0.8000000 0.8000000 0.8000000 0.5000000 1.0000000</span>
<span class="co"># [15] 1.0000000 0.2000000 0.2000000 0.2873749 0.2000000 0.2000000 1.0000000</span>
<span class="co"># [22] 0.2000000 0.2000000 0.2000000 0.2000000 0.2000000 0.2000000 0.8000000</span>
<span class="co"># [29] 0.8000000 0.8000000 0.8000000 0.8000000</span>
<span class="co">## visualization</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/plot_curvefits.html">plot_curvefits</a></span><span class="op">(</span><span class="va">d_fit</span>, <span class="va">brks2</span>, <span class="cn">NULL</span>, title.ylab <span class="op">=</span> <span class="st">"NDVI"</span>, <span class="st">"Time"</span>,
                   theme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2000-04-01"</span><span class="op">)</span>, <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2017-07-31"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span>
<span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span>; <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html">grid.draw</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="co"># plot to check the curve fitting</span></code></pre></div>
<p><img src="man/Figure/curve%20fitting-1.svg" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># write_fig(g, "Figure1_phenofit_curve_fitting.pdf", 10, 6)</span></code></pre></div>
</div>
<div id="25-extract-phenology" class="section level2">
<h2 class="hasAnchor">
<a href="#25-extract-phenology" class="anchor"></a>2.5 Extract phenology</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># pheno: list(p_date, p_doy)</span>
<span class="va">l_pheno</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_pheno.html">get_pheno</a></span><span class="op">(</span><span class="va">fit</span>, IsPlot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="co">#%&gt;% map(~melt_list(., "meth"))</span>

<span class="co"># ratio = 1.15</span>
<span class="co"># file &lt;- "Figure5_Phenology_Extraction_temp.pdf"</span>
<span class="co"># cairo_pdf(file, 8*ratio, 6*ratio)</span>
<span class="co"># temp &lt;- get_pheno(fit$fits$ELMORE[2:6], IsPlot = T)</span>
<span class="co"># dev.off()</span>
<span class="co"># file.show(file)</span>

<span class="co">## check the extracted phenology</span>
<span class="va">pheno</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_pheno.html">get_pheno</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="st">"Elmore"</span>, IsPlot <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p><img src="man/Figure/Extract%20phenology-1.svg" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># print(str(pheno, 1))</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">l_pheno</span><span class="op">$</span><span class="va">doy</span><span class="op">$</span><span class="va">AG</span><span class="op">)</span>
<span class="co">#      flag     origin TRS2.sos TRS2.eos TRS5.sos TRS5.eos TRS6.sos TRS6.eos</span>
<span class="co"># 1: 2000_1 2000-01-01      167      275      175      264      177      261</span>
<span class="co"># 2: 2001_1 2001-01-01      145      263      154      255      157      252</span>
<span class="co"># 3: 2002_1 2002-01-01      164      284      178      256      182      248</span>
<span class="co"># 4: 2003_1 2003-01-01      132      273      149      253      153      247</span>
<span class="co"># 5: 2004_1 2004-01-01      162      264      173      252      176      248</span>
<span class="co"># 6: 2005_1 2005-01-01      148      268      159      254      162      250</span>
<span class="co">#    DER.sos DER.pop DER.eos  UD  SD  DD  RD Greenup Maturity Senescence Dormancy</span>
<span class="co"># 1:     175     200     266 163 186 249 281     157      194        243      287</span>
<span class="co"># 2:     152     214     256 140 168 241 268     133      174        235      274</span>
<span class="co"># 3:     182     204     248 161 196 222 292     153      203        219      307</span>
<span class="co"># 4:     153     180     254 127 170 228 282     118      179        197      294</span>
<span class="co"># 5:     171     229     248 157 189 235 268     150      196        274       NA</span>
<span class="co"># 6:     157     225     249 143 175 233 273     135      181        281       NA</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a><strong>References</strong>
</h1>
<blockquote>
<p><br><span class="math display">1</span><br> Kong, D., Zhang, Y., Wang, D., Chen, J., &amp; Gu, X. (2020). Photoperiod Explains the Asynchronization Between Vegetation Carbon Phenology and Vegetation Greenness Phenology. <em>Journal of Geophysical Research: Biogeosciences</em>, 125(8), e2020JG005636. <a href="https://doi.org/10.1029/2020JG005636" class="uri">https://doi.org/10.1029/2020JG005636</a></p>
<p><br><span class="math display">2</span><br> Kong, D., Zhang, Y., Gu, X., &amp; Wang, D. (2019). A robust method for reconstructing global MODIS EVI time series on the Google Earth Engine. <em>ISPRS Journal of Photogrammetry and Remote Sensing</em>, 155, 13–24.</p>
<p><br><span class="math display">3</span><br> Kong, D., (2020). R package: A state-of-the-art Vegetation Phenology extraction package, <code>phenofit</code> version 0.2.6, <a href="https://doi.org/10.5281/zenodo.3605560" class="uri">https://doi.org/10.5281/zenodo.3605560</a></p>
<p><br><span class="math display">4</span><br> Zhang, Q., Kong, D., Shi, P., Singh, V.P., Sun, P., 2018. Vegetation phenology on the Qinghai-Tibetan Plateau and its response to climate change (1982–2013). Agric. For. Meteorol. 248, 408–417. <a href="https://doi.org/10.1016/j.agrformet.2017.10.026" class="uri">https://doi.org/10.1016/j.agrformet.2017.10.026</a></p>
</blockquote>
</div>
<div id="acknowledgements" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgements" class="anchor"></a>Acknowledgements</h1>
<p>Keep in mind that this repository is released under a GPL2 license, which permits commercial use but requires that the source code (of derivatives) is always open even if hosted as a web service.</p>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=phenofit">https://​cloud.r-project.org/​package=phenofit</a>
</li>
<li>Browse source code at <br><a href="https://github.com/kongdd/phenofit/">https://​github.com/​kongdd/​phenofit/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/kongdd/phenofit/issues">https://​github.com/​kongdd/​phenofit/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Dongdong Kong <br><small class="roles"> Author, maintainer </small>  </li>
<li>Mingzhong Xiao <br><small class="roles"> Author </small>  </li>
<li>Yongqiang Zhang <br><small class="roles"> Author </small>  </li>
<li>Xihui Gu <br><small class="roles"> Author </small>  </li>
<li>Jianjian Cui <br><small class="roles"> Author </small>  </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/kongdd/phenofit"><img src="https://travis-ci.org/kongdd/phenofit.svg?branch=master" alt="Travis Build Status"></a></li>
<li><a href="https://ci.appveyor.com/project/kongdd/phenofit"><img src="https://ci.appveyor.com/api/projects/status/github/kongdd/phenofit?branch=master&amp;svg=true" alt="AppVeyor Build Status"></a></li>
<li><a href="https://codecov.io/gh/kongdd/phenofit"><img src="https://codecov.io/gh/kongdd/phenofit/branch/master/graph/badge.svg" alt="codecov"></a></li>
<li><a href="http://www.gnu.org/licenses/gpl-2.0.html"><img src="http://img.shields.io/badge/license-GPL%20%28%3E=%202%29-brightgreen.svg?style=flat" alt="License"></a></li>
<li><a href="https://cran.r-project.org/package=phenofit"><img src="http://www.r-pkg.org/badges/version/phenofit" alt="CRAN"></a></li>
<li><a href="https://www.rpackages.io/package/phenofit"><img src="http://cranlogs.r-pkg.org/badges/grand-total/phenofit" alt="total"></a></li>
<li><a href="https://www.rpackages.io/package/phenofit"><img src="http://cranlogs.r-pkg.org/badges/phenofit" alt="monthly"></a></li>
<li><a href="https://doi.org/10.5281/zenodo.3605560"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.3605560.svg" alt="DOI"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Dongdong Kong, Mingzhong Xiao, Yongqiang Zhang, Xihui Gu, Jianjian Cui.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
